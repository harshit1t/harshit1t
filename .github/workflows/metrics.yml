name: Update Metrics Table

on:
  schedule:
    - cron: '17 */12 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  metrics_table:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Update metrics table in README
        env:
          GH_USERNAME: ${{ github.repository_owner }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          user_json=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" https://api.github.com/users/$GH_USERNAME)
          followers=$(echo "$user_json" | jq '.followers')
          repos_json=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "https://api.github.com/users/$GH_USERNAME/repos?per_page=100")
          total_stars=$(echo "$repos_json" | jq '[.[].stargazers_count] | add // 0')
          public_repos=$(echo "$user_json" | jq '.public_repos')
          updated=$(date -u +'%Y-%m-%d %H:%M UTC')
          printf '%s\n' '| Metric | Value |' '|--------|-------|' "| ⭐ Stars (first 100 repos) | $total_stars |" "| 📦 Public Repos | $public_repos |" "| 👥 Followers | $followers |" "| ⏱ Last Refresh | $updated |" > /tmp/metrics.md
          awk 'BEGIN{p=1}/<!-- STATS:START -->/{print;system("cat /tmp/metrics.md");p=0}/<!-- STATS:END -->/{p=1}p' README.md > README.tmp && mv README.tmp README.md
      - name: Commit changes
        run: |
          if git diff --quiet; then exit 0; fi
          git config user.name github-actions
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          git add README.md
          git commit -m "chore: metrics table refresh"
          git push
